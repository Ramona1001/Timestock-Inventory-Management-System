<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Times Stock IMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">
  <link rel="stylesheet" href="../css/Settings.css?v=3">
  <style>
:root {
    --border-radius-1: 4px;
    --border-radius-2: 8px;
    --box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: var(--border-radius-2);
    width: 90%;
    max-width: 450px;
    box-shadow: var(--box-shadow);
    position: relative;
}

.modal-header {
    padding: 20px 20px 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 20px;
}

.modal-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.close {
    font-size: 24px;
    color: #999;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    background: none;
    border: none;
}

.close:hover {
    color: #333;
}

.modal-body {
    padding: 0 20px 20px 20px;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 13px;
    font-weight: 500;
    color: #555;
    margin-bottom: 5px;
}

.modal-content input,
.modal-content select {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius-1);
    font-size: 14px;
    transition: border-color 0.2s;
}

.modal-content input:focus,
.modal-content select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.modal-actions {
    padding: 15px 20px 20px 20px;
    border-top: 1px solid #f0f0f0;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.modal-actions button[type="submit"],
.modal-actions button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--border-radius-1);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.modal-actions button[type="submit"]:hover,
.modal-actions button:hover {
    background: #0056b3;
}

/* Migration modal specific styling */
.migration-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: var(--border-radius-1);
    border-left: 4px solid #007bff;
    margin-bottom: 20px;
}

.migration-info p {
    margin: 0;
    font-size: 14px;
    color: #666;
}

#migrateBtn {
    background: #cbe3d1;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--border-radius-1);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    width: 100%;
}

#migrateBtn:hover {
    background: #1e7e34;
}

@media (max-width: 480px) {
    .modal-content {
        margin: 10% auto;
        max-width: 95%;
    }

    .form-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .modal-actions {
        flex-direction: column-reverse;
    }
}

/* Demo button for testing */
.demo-buttons {
    padding: 20px;
    text-align: center;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}

.demo-btn {
    background: #007bff;
    color: rgb(255, 255, 255);
    border: none;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}



    .top h2 {
  margin: 0;
  position: relative;
  left: -20px;  /* adjust this value to move left */
}
  </style>
</head>
<body>
  <div class="container">
    <aside>
      <div class="top">
        <div class="logo">
          <img src="../images/TIMESTOCK_BG.png">
        </div>
          <h2>TIME<span class="danger">STOCK</span></h2>
        <div class="close" id="close-btn">
            <span class="material-symbols-sharp">close </span>        
      </div>
    </div>

       {% include "sidebar.html" %}
</aside>
<!-----END OF ASIDE MUENU----->
<main>
  <div class="header-bar">
  <h1>Settings Management</h1>
  <div class="top-bar">
        {% include 'alert.html' %}
        {% include "profile.html" %}
  </div>
</div>
    <div class="demo-buttons">
        <button class="demo-btn" onclick="openModal('addEmployeeModal')">Add Employee</button>
        <button class="demo-btn" onclick="openModal('statusModal')">Change Status</button>
        <button class="demo-btn" onclick="openModal('passwordModal')">Change Password</button>
        <button class="demo-btn" onclick="openModal('migrateModal')">Migration</button>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Employee</h2>
                <span class="close" onclick="closeModal('addEmployeeModal')">&times;</span>
            </div>
            <form id="addEmployeeForm">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="firstname">First Name</label>
                            <input type="text" name="firstname" placeholder="First Name" required>
                        </div>
                        <div class="form-group">
                            <label for="lastname">Last Name</label>
                            <input type="text" name="lastname" placeholder="Last Name" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="email">Email Address</label>
                            <input type="email" name="email" placeholder="Email" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="password">Password</label>
                            <input type="password" name="password" placeholder="Password" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="contact_number">Contact Number</label>
                            <input type="text" name="contact_number" placeholder="Contact Number" required>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit">Add Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Employee Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Employee Status</h2>
                <span class="close" onclick="closeModal('statusModal')">&times;</span>
            </div>
            <form id="statusForm">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="employee_id">Employee ID</label>
                            <input type="text" name="id" placeholder="Employee ID" required>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select name="is_active" required>
                                <option value="" disabled selected>Select Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Employee Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Employee Password</h2>
                <span class="close" onclick="closeModal('passwordModal')">&times;</span>
            </div>
            <form id="passwordForm">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="target_employee_id">Employee ID</label>
                            <input type="text" name="target_employee_id" placeholder="Employee ID" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="new_password">New Password</label>
                            <input type="password" name="new_password" placeholder="New Password" required>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Migrate Password Hashes Modal -->
    <div id="migrateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Migrate Password Hashes</h2>
                <span class="close" onclick="closeModal('migrateModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="migration-info">
                    <p><strong>Warning:</strong> This will update all employee password hashes in the database. This action cannot be undone. Please ensure you have a backup before proceeding.</p>
                </div>
                <button id="migrateBtn">Run Migration</button>
            </div>
        </div>
    </div>
<!-- START OF TESTING HTML -->

<section class="maintenance-card" aria-labelledby="maintenance-title">
  <h2 id="maintenance-title">Delete Old Transactions</h2>
  <p class="muted">Preview what would be deleted before confirming. Minimum allowed value: <strong>5</strong> years.</p>

  <div class="maintenance-row" style="margin-top:0.8rem;">
    <label for="yearsToKeep">Years to keep</label>
    <input id="yearsToKeep" type="number" min="2" value="2" aria-describedby="yearsHelp" />
    <div id="yearsHelp" class="muted">Records older than <em>now − years</em> will be affected.</div>

    <div style="margin-left:auto; display:flex; gap:0.5rem;">
      <button id="previewDeleteBtn" class="btn btn-primary" type="button">Preview</button>
      <button id="openDeleteModalBtn" class="btn btn-danger" type="button" disabled>Delete</button>
    </div>
  </div>

  <div id="previewBlock" class="hidden" style="margin-top:1rem;">
    <div class="notice" role="status" aria-live="polite">
      <div id="previewMessage"><strong>Preview:</strong> Checking counts…</div>
    </div>

    <ul id="previewCounts" style="margin-top:0.6rem;">
      <li>Order rows: <span id="previewOrders">0</span></li>
      <li>Order item rows: <span id="previewOrderItems">0</span></li>
      <li>Stock transactions: <span id="previewStocks">0</span></li>
      <li>Stock item rows: <span id="previewStockItems">0</span></li>
    </ul>

    <div id="previewCutoff" class="muted" style="margin-top:0.6rem;">Cutoff date: <span id="previewCutoffDate">—</span></div>
  </div>
</section>

<!-- Confirmation Modal (hidden by default) -->
<div id="deleteConfirmModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="modal-backdrop"></div>
  <div class="modal-content" role="document">
    <h3 id="confirmTitle">Confirm Delete</h3>
    <p id="confirmMessage">You are about to delete <strong id="confirmTotal">0</strong> records of transaction history.</p>

    <div style="margin-top:8px;">
      <ul>
        <li>Order rows: <strong id="confirmOrders">0</strong></li>
        <li>Order item rows: <strong id="confirmOrderItems">0</strong></li>
        <li>Stock transactions: <strong id="confirmStocks">0</strong></li>
        <li>Stock item rows: <strong id="confirmStockItems">0</strong></li>
      </ul>
    </div>

    <div id="confirmCutoff" class="muted" style="margin-top:8px;">Cutoff date: <span id="confirmCutoffDate">—</span></div>

    <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="cancelDeleteBtn" class="btn" type="button">Decline</button>
      <button id="confirmDeleteBtn" class="btn btn-danger" type="button">Accept</button>
    </div>
  </div>
</div>

<section class="maintenance-card" aria-labelledby="maintenance-title">
  <h2>Audit Logs</h2>

    <div id="controls" style="margin-bottom:12px;">
      <button id="prevBtn">Prev</button>
      <span id="pageInfo" style="margin:0 8px">Page 1</span>
      <button id="nextBtn">Next</button>
    </div>

    <div class="table-wrapper">
      <!-- table area + slider side-by-side -->
      <div class="table-container">
        <table id="auditTable">
          <thead>
            <tr>
              <th>ID</th><th>Entity</th><th>Entity ID</th><th>Action</th><th>Details</th><th>User</th><th>Time</th>
            </tr>
          </thead>
          <!-- The tbody is wrapped so we can control scrolling height -->
          <tbody id="auditBody"></tbody>
        </table>
      </div>

      <!-- vertical slider to scroll the table body -->
      <div class="slider-container">
        <input id="verticalSlider" type="range" min="0" max="100" value="0" orient="vertical">
      </div>
    </div>

    <div id="pagination" style="margin-top:12px;"></div>
  <script src="audit_with_slider.js"></script>
</section>

<!-- END OF TESTING HTML -->

</body>
</html>

<script>
  const notificationIcon = document.getElementById("notificationToggle");
  const dropdownMenu = document.getElementById("notificationDropdown");

  document.addEventListener("click", function (e) {
    const isInside = notificationIcon.contains(e.target) || dropdownMenu.contains(e.target);
    if (!isInside) {
      dropdownMenu.style.display = "none";
    }
  });

  notificationIcon.addEventListener("click", function (e) {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  });
</script>

<script>
async function postData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response.json();
}

async function putData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response.json();
}

// Add Employee
document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));
  const res = await postData('/api/settings/add-employees', formData);
  alert(JSON.stringify(res));
});

// Update Status
document.getElementById('statusForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));
  const res = await putData(`/api/settings/${formData.id}/status`, { is_active: formData.is_active === "true" });
  alert(JSON.stringify(res));
});

// Change Password
const adminId = "{{ user.id }}"; // passed from backend via user dict

async function postData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response.json();
}

document.getElementById('passwordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));

  const payload = {
    target_employee_id: formData.target_employee_id,
    new_password: formData.new_password
  };

  const res = await postData('/api/settings/change-employee-password', payload);
  alert(JSON.stringify(res));
});

// Migrate Hashes
document.getElementById('migrateBtn').addEventListener('click', async () => {
  const res = await postData('/api/settings/migrate-hashes', {});
  alert(JSON.stringify(res));
});
</script>

<script>
const API_BASE = '/api';

const previewUrl = years => `${API_BASE}/maintenance/preview-delete/${encodeURIComponent(years)}`;
const deleteUrl  = years => `${API_BASE}/maintenance/delete-old-transactions/${encodeURIComponent(years)}`;

async function fetchJson(url, options = {}) {
  const opts = {
    credentials: 'include',
    headers: { 'Accept': 'application/json' },
    ...options
  };
  if (opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(opts.body);
  }
  const resp = await fetch(url, opts);
  const text = await resp.text();
  let json = null;
  try { json = text ? JSON.parse(text) : null; } catch (e) { /* not json */ }
  if (!resp.ok) {
    const detail = (json && (json.detail || json.message)) || text || resp.statusText;
    const err = new Error(detail);
    err.status = resp.status;
    throw err;
  }
  return json;
}

/* UI elements */
const previewBtn = document.getElementById('previewDeleteBtn');
const deleteBtn = document.getElementById('openDeleteModalBtn');
const yearsInput = document.getElementById('yearsToKeep');

const previewBlock = document.getElementById('previewBlock');
const previewMessage = document.getElementById('previewMessage');
const previewOrders = document.getElementById('previewOrders');
const previewOrderItems = document.getElementById('previewOrderItems');
const previewStocks = document.getElementById('previewStocks');
const previewStockItems = document.getElementById('previewStockItems');
const previewCutoffDate = document.getElementById('previewCutoffDate');

const modal = document.getElementById('deleteConfirmModal');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

const confirmTotal = document.getElementById('confirmTotal');
const confirmOrders = document.getElementById('confirmOrders');
const confirmOrderItems = document.getElementById('confirmOrderItems');
const confirmStocks = document.getElementById('confirmStocks');
const confirmStockItems = document.getElementById('confirmStockItems');
const confirmCutoffDate = document.getElementById('confirmCutoffDate');

function showPreviewBlock() {
  previewBlock.classList.remove('hidden');
}
function hidePreviewBlock() {
  previewBlock.classList.add('hidden');
}
function openModal() { modal.classList.remove('hidden'); }
function closeModal() { modal.classList.add('hidden'); }

/* compute total helper */
function totalFromResult(res) {
  return (res.old_order_items || 0) + (res.old_orders || 0) + (res.old_stock_items || 0) + (res.old_stocks || 0);
}

/* Preview flow */
previewBtn.addEventListener('click', async () => {
  const years = Number(yearsInput.value || 0);
  if (!years || years < 2) {
    alert('Please enter a number >= 5 for years.');
    return;
  }

  // show loading state
  showPreviewBlock();
  previewMessage.textContent = 'Preview: checking counts…';
  previewOrders.textContent = previewOrderItems.textContent = previewStocks.textContent = previewStockItems.textContent = '-';
  previewCutoffDate.textContent = '—';
  deleteBtn.disabled = true;

  try {
    const res = await fetchJson(previewUrl(years), { method: 'GET' });

    if (res && res.message && (res.message.indexOf("Data still") === 0 || res.message.indexOf("Data still") !== -1)) {
      // special zero-result message from server
      previewMessage.innerHTML = `<strong>Preview:</strong> ${res.message}`;
      previewOrders.textContent = previewOrderItems.textContent = previewStocks.textContent = previewStockItems.textContent = '0';
      previewCutoffDate.textContent = res.cutoff_date || '—';
      deleteBtn.disabled = true; // nothing to delete
      return;
    }

    // Normal preview result with counts
    previewOrders.textContent = res.old_orders ?? 0;
    previewOrderItems.textContent = res.old_order_items ?? 0;
    previewStocks.textContent = res.old_stocks ?? 0;
    previewStockItems.textContent = res.old_stock_items ?? 0;
    previewCutoffDate.textContent = res.cutoff_date ?? '—';

    const total = totalFromResult(res);
    previewMessage.innerHTML = `<strong>Preview:</strong> This operation would delete <strong>${total}</strong> records.`;

    // enable Delete button only if total > 0
    deleteBtn.disabled = total === 0;

    // store the last preview response on the delete button element for use later
    deleteBtn._previewData = res;

  } catch (err) {
    console.error(err);
    previewMessage.textContent = 'Error fetching preview: ' + (err.message || 'Unknown error');
    deleteBtn.disabled = true;
  }
});

/* Open modal with preview data */
deleteBtn.addEventListener('click', (e) => {
  const data = deleteBtn._previewData;
  if (!data) return alert('Please run Preview first.');

  const total = totalFromResult(data);
  confirmTotal.textContent = total;
  confirmOrders.textContent = data.old_orders ?? 0;
  confirmOrderItems.textContent = data.old_order_items ?? 0;
  confirmStocks.textContent = data.old_stocks ?? 0;
  confirmStockItems.textContent = data.old_stock_items ?? 0;
  confirmCutoffDate.textContent = data.cutoff_date ?? '—';

  // show modal and make Accept clickable
  openModal();
});

/* Cancel modal */
cancelDeleteBtn.addEventListener('click', () => {
  closeModal();
});

/* Confirm delete (perform destructive action) */
confirmDeleteBtn.addEventListener('click', async () => {
  // disable the button once clicked to avoid double submissions
  confirmDeleteBtn.disabled = true;
  confirmDeleteBtn.textContent = 'Deleting…';

  const years = Number(yearsInput.value || 0);
  try {
    const res = await fetchJson(deleteUrl(years), { method: 'DELETE' });

    const totalDeleted = (res.old_order_items || 0) + (res.old_orders || 0) + (res.old_stock_items || 0) + (res.old_stocks || 0);
    // show success in modal and preview area
    confirmTotal.textContent = totalDeleted;
    previewMessage.innerHTML = `<strong>Success:</strong> Deleted ${totalDeleted} rows.`;
    previewOrders.textContent = res.old_orders ?? 0;
    previewOrderItems.textContent = res.old_order_items ?? 0;
    previewStocks.textContent = res.old_stocks ?? 0;
    previewStockItems.textContent = res.old_stock_items ?? 0;
    previewCutoffDate.textContent = res.cutoff_date ?? '—';

    // close modal after a short delay
    setTimeout(() => {
      closeModal();
      confirmDeleteBtn.disabled = false;
      confirmDeleteBtn.textContent = 'Accept';
      // disable Delete button now (nothing left to delete)
      deleteBtn.disabled = true;
    }, 1200);

  } catch (err) {
    console.error(err);
    alert('Delete failed: ' + (err.message || 'server error'));
    confirmDeleteBtn.disabled = false;
    confirmDeleteBtn.textContent = 'Accept';
  }
});

/* Make clicking the backdrop close the modal */
document.addEventListener('click', (ev) => {
  if (!modal || modal.classList.contains('hidden')) return;
  // if the click target is the backdrop, close
  const backdrop = modal.querySelector('.modal-backdrop');
  if (backdrop && backdrop.contains(ev.target)) {
    closeModal();
  }
});

/* TEST */

const API = '/api/audit-logs';
const PAGE_SIZE = 10;  // 10 rows per page
let logs = [];         // full dataset loaded from server
let currentPage = 1;

const auditBody = document.getElementById('auditBody');
const pageInfo = document.getElementById('pageInfo');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const paginationDiv = document.getElementById('pagination');
const slider = document.getElementById('verticalSlider');

// fetch logs and initialize UI
async function init() {
  try {
    const resp = await fetch(`${API}?limit=1000`); // fetch many; adapt if you want server pagination
    if (!resp.ok) throw new Error('Failed to fetch audit logs: ' + resp.status);
    const json = await resp.json();
    logs = (json.logs || []).sort((a,b) => {
      // try to sort by action_time descending if present
      const ta = a.action_time || a.timestamp || '';
      const tb = b.action_time || b.timestamp || '';
      return String(tb).localeCompare(String(ta));
    });
    renderPagination();
    renderPage(1);
  } catch (err) {
    console.error(err);
    auditBody.innerHTML = `<tr><td colspan="7">Error loading logs: ${err.message}</td></tr>`;
  }
}

function renderPage(page) {
  currentPage = Math.max(1, Math.min(page, Math.ceil(logs.length / PAGE_SIZE) || 1));
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = logs.slice(start, start + PAGE_SIZE);

  auditBody.innerHTML = '';
  if (pageRows.length === 0) {
    auditBody.innerHTML = `<tr><td colspan="7">No audit logs</td></tr>`;
  } else {
    // create up to PAGE_SIZE rows (the scroll window will show first 5 by default)
    for (const log of pageRows) {
      const user = log.admin_id || log.employee_id || '';
      const time = log.action_time || log.timestamp || '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${log.id ?? ''}</td>
        <td title="${escapeHtml(log.entity ?? '')}">${log.entity ?? ''}</td>
        <td title="${escapeHtml(log.entity_id ?? '')}">${log.entity_id ?? ''}</td>
        <td title="${escapeHtml(log.action ?? '')}">${log.action ?? ''}</td>
        <td title="${escapeHtml(log.details ?? '')}">${log.details ?? ''}</td>
        <td>${user}</td>
        <td>${time}</td>
      `;
      auditBody.appendChild(tr);
    }
  }

  // reset scrolling and slider
  const tbody = auditBody.parentElement; // tbody element (we used #auditBody as the tbody)
  tbody.scrollTop = 0;
  slider.value = 0;
  pageInfo.textContent = `Page ${currentPage} / ${Math.max(1, Math.ceil(logs.length / PAGE_SIZE))}`;

  // show/hide slider: only needed if pageRows length > 5
  const showSlider = pageRows.length > 5;
  document.querySelector('.slider-container').style.display = showSlider ? 'flex' : 'none';
  updatePageButtons();
}

// pagination UI
function renderPagination() {
  const totalPages = Math.max(1, Math.ceil(logs.length / PAGE_SIZE));
  paginationDiv.innerHTML = '';
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = (i === currentPage) ? 'active' : '';
    btn.onclick = () => renderPage(i);
    paginationDiv.appendChild(btn);
  }
}

function updatePageButtons() {
  const totalPages = Math.max(1, Math.ceil(logs.length / PAGE_SIZE));
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= totalPages;
  // refresh page number buttons (simple approach: re-render numbers)
  renderPagination();
}

// Prev/Next handlers
prevBtn.addEventListener('click', () => { renderPage(currentPage - 1); });
nextBtn.addEventListener('click', () => { renderPage(currentPage + 1); });

// Slider <-> scroll sync
const tbodyElement = () => auditBody.parentElement; // the actual tbody element (display:block)

slider.addEventListener('input', () => {
  const tbody = tbodyElement();
  // slider is 0..100; map percent to scrollTop
  const pct = Number(slider.value) / 100;
  const maxScroll = Math.max(0, tbody.scrollHeight - tbody.clientHeight);
  tbody.scrollTop = Math.round(pct * maxScroll);
});

// if user scrolls with mouse, update slider position
auditBody.parentElement?.addEventListener?.('scroll', () => {
  const tbody = tbodyElement();
  const maxScroll = Math.max(1, tbody.scrollHeight - tbody.clientHeight);
  const pct = Math.round((tbody.scrollTop / maxScroll) * 100);
  slider.value = pct;
});

// helper
function escapeHtml(s) {
  if (!s) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// Initialize when DOM ready
document.addEventListener('DOMContentLoaded', init);

/* End of maintenance JS */
</script>


    <script>
        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Demo form submission handlers
        document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Employee would be added here');
            closeModal('addEmployeeModal');
        });

        document.getElementById('statusForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Employee status would be updated here');
            closeModal('statusModal');
        });

        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Employee password would be changed here');
            closeModal('passwordModal');
        });

        document.getElementById('migrateBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to run the password migration? This cannot be undone.')) {
                alert('Migration would run here');
                closeModal('migrateModal');
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = ['addEmployeeModal', 'statusModal', 'passwordModal', 'migrateModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>