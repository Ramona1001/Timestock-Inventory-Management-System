<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Times Stock IMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">
  <link rel="stylesheet" href="../css/reports.css?v=1">
  <style>
    
  </style>
</head>
<body>
  <div class="container">
    <aside>
      <div class="top">
        <div class="logo">
          <img src="../images/TIMESTOCK_BG.png">
          <h2>TIME<span class="danger">STOCK</span></h2>
        </div>
        <div class="close" id="close-btn">
            <span class="material-symbols-sharp">close </span>        
      </div>
    </div>

<div class="sidebar">
  <a href="index.html"><span class="material-symbols-sharp">dashboard</span><h3>Overview</h3></a>
  <a href="product.html"><span class="material-symbols-sharp">package_2</span><h3>Product</h3></a>
  <a href="Materials.html"><span class="material-symbols-sharp">handyman</span><h3>Materials</h3></a>
  <a href="Analytics.html"><span class="material-symbols-sharp">monitoring</span><h3>Analytics</h3></a>
  <a href="Reports.html"><span class="material-symbols-sharp">lab_profile</span><h3>Reports</h3></a>
  <a href="Transactions.html"><span class="material-symbols-sharp">dashboard</span><h3>Transactions</h3></a>
  <a href="Customer.html"><span class="material-symbols-sharp">groups</span><h3>Customer</h3></a>
  <a href="Supplier.html"><span class="material-symbols-sharp">factory</span><h3>Supplier</h3></a>
  <a href="Order_and_Quotation.html"><span class="material-symbols-sharp">contract_edit</span><h3>Order & Quotation</h3></a>
  <a href="Settings.html"><span class="material-symbols-sharp">settings</span><h3>Settings</h3></a>
  <a href="/logout">
    <span class="material-symbols-sharp">logout</span>    
    <h3>Sign-out</h3>
  </a>
</div>
</aside>
<!-----END OF ASIDE MUENU----->
<main>
  <div class="header-bar">
  <h1>Reports</h1>
  <div class="top-bar">
        {% include 'alert.html' %}
    <p class="greeting">Hey, <b>Emma-Nulle</b></p>
    <small class="text-muted">Admin</small>
    <div class="profile-photo">
      <img src="../images/admin-profile!.png" />
    </div>
  </div>
</div>

  <form method="get" action="/Reports.html">
    <label for="year">Year:</label>
    <input type="number" name="year" id="year" min="2020" max="2100" required>
    
    <label for="month">Month:</label>
    <input type="number" name="month" id="month" min="1" max="12" required>

    <button type="submit">Generate Report</button>
  </form>


{% if report_text and not report_text.empty %}
  <div class="report-section">
    <h3>{{ report_text.title }}</h3>
    <p><strong>Total Orders:</strong> {{ report_text.total_orders }}</p>
    <p><strong>Total Sales:</strong> {{ report_text.total_sales }}</p>
    <p><strong>Total Revenue:</strong> Php{{ "{:,.2f}".format(report_text.total_revenue) }}</p>

    <h4>Daily Breakdown</h4>
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Orders</th>
          <th>Sales</th>
          <th>Revenue</th>
        </tr>
      </thead>
      <tbody>
        {% for row in report_text.breakdown %}
        <tr>
          <td>{{ row.day }}</td>
          <td>{{ row.orders }}</td>
          <td>{{ row.sales }}</td>
          <td>Php{{ "{:,.2f}".format(row.revenue) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% elif report_text and report_text.empty %}
  <p>{{ report_text.message }}</p>
{% endif %}


{% if turnover_report and not turnover_report.empty %}
  <div class="report-section">
    <h3>{{ turnover_report.title }}</h3>
    <p><strong>COGS:</strong> Php{{ "{:,.2f}".format(turnover_report.cogs) }}</p>
    <p><strong>Average Inventory:</strong> Php{{ "{:,.2f}".format(turnover_report.avg_inventory) }}</p>
    <p><strong>Turnover Rate:</strong> {{ "%.2f"|format(turnover_report.turnover_rate) }} times</p>
    <p><em>{{ turnover_report.interpretation }}</em></p>
  </div>
{% elif turnover_report and turnover_report.empty %}
  <p>{{ turnover_report.message }}</p>
{% endif %}


{% if stl_report and not stl_report.empty %}
  <div class="report-section">
    <h3>{{ stl_report.title }}</h3>
    <p><strong>Top-Ordered Product:</strong> {{ stl_report.top_product }}</p>
    <p><strong>Trend Component:</strong> {{ "%.2f"|format(stl_report.trend) }}</p>
    <p><strong>Seasonal Component:</strong> {{ "%.2f"|format(stl_report.seasonal) }}</p>
    <p><strong>Residual Component:</strong> {{ "%.2f"|format(stl_report.residual) }}</p>

    <h4>Interpretation</h4>
    <ul>
      {% for interp in stl_report.interpretations %}
        <li>{{ interp }}</li>
      {% endfor %}
    </ul>
  </div>
{% elif stl_report and stl_report.empty %}
  <p>{{ stl_report.message }}</p>
{% endif %}


{% if moving_avg_report and not moving_avg_report.empty %}
  <section class="report-section card" style="margin-top:1rem;">
    <div class="card-body">
      <h3 class="card-title">{{ moving_avg_report.title }}</h3>

      <div class="row" style="margin: .5rem 0;">
        <div class="col">
          <p><strong>Total Sales:</strong>
            Php{{ "{:,.2f}".format(moving_avg_report.total_sales) }}
          </p>
        </div>
        <div class="col">
          <p><strong>Top-Selling Product:</strong>
            {{ moving_avg_report.top_product }}
          </p>
        </div>
      </div>

      <div class="row" style="margin: .5rem 0;">
        <div class="col">
          <p><strong>3-Month Moving Average:</strong>
            {% if moving_avg_report.ma3 is not none %}
              Php{{ "{:,.2f}".format(moving_avg_report.ma3) }}
            {% else %}
              <em>Not enough data</em>
            {% endif %}
          </p>
        </div>
        <div class="col">
          <p><strong>6-Month Moving Average:</strong>
            {% if moving_avg_report.ma6 is not none %}
              Php{{ "{:,.2f}".format(moving_avg_report.ma6) }}
            {% else %}
              <em>Not enough data</em>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </section>
{% elif moving_avg_report and moving_avg_report.empty %}
  <section class="report-section" style="margin-top:1rem;">
    <p>{{ moving_avg_report.message }}</p>
  </section>
{% endif %}



<!-- Download PDF Button -->
<button id="downloadPdfBtn" class="btn btn-primary">Download PDF</button>
  </div>
</body>
</html>
<script>
  const notificationIcon = document.getElementById("notificationToggle");
  const dropdownMenu = document.getElementById("notificationDropdown");

  document.addEventListener("click", function (e) {
    const isInside = notificationIcon.contains(e.target) || dropdownMenu.contains(e.target);
    if (!isInside) {
      dropdownMenu.style.display = "none";
    }
  });

  notificationIcon.addEventListener("click", function (e) {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  });
</script>

<script>
  document.getElementById("downloadPdfBtn").addEventListener("click", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const year = urlParams.get("year");
    const month = urlParams.get("month");

    if (!year) {
      alert("Please select a year before downloading the report.");
      return;
    }

    // Build API URL
    let apiUrl = `/api/reports/pdf?year=${year}`;
    if (month) {
      apiUrl += `&month=${month}`;
    }

    // Trigger PDF download
    window.location.href = apiUrl;
  });
</script>